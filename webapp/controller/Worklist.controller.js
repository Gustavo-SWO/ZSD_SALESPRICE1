sap.ui.define(["./BaseController","../model/formatter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/MessageType","../util/DynamicalAreaUtil","sap/ui/generic/app/navigation/service/NavigationHandler","sap/ui/comp/state/UIState"],function(e,t,i,a,s,o,r,n){return e.extend("zzcus.sd.salesprices.manage.controller.Worklist",{formatter:t,aTables:[],aTypes:[],aShowObj:[],aCopyFields:[],aBingFilters:[],sSelectAll:"",vQuantityPos:"",vConditionTablePos:"",vEditStatusPos:"",iSizeBeforeCreate:0,iRowHeight:0,bValueChange:!1,bTableChange:!1,bQuantityUnitChange:!1,bMaterialChange:!1,bCalculationType:!1,bSearch:!1,sPopInfo:"",iTotalEditableRecords:0,iTotalRecords:0,bRateValueError:!1,sRateValueField:"",bOnInitFinished:!1,bFilterBarInitialized:!1,bApproveFeature:!1,aRequestConditions:[],bRateValueUnitchanged:!1,vConditionLowerLimitPos:"",vConditionUpperLimitPos:"",onInit:async function(){this._clearMsg();var e=new sap.ui.model.json.JSONModel;this.setModel(e,"message"),this._oResourceBundle=this.getOwnerComponent().getModel("i18n").getResourceBundle(),this._oSmartTable=this.byId("LineItemsSmartTable"),this._oSmartFilterBar=this.byId("smartFilterBar"),this._oTable=this._oSmartTable.getTable(),this._oDraftIndi=this.byId("draftIndi"),this._oDynamicPage=this.byId("listPage"),this._oBusyModel=new sap.ui.model.json.JSONModel({isBusy:!1,isVisible:!1,sApproveInfo:""}),this.setModel(this._oBusyModel,"busy"),this._oTable.setSelectionMode("MultiToggle");var t=new sap.ui.table.plugins.MultiSelectionPlugin({limit:0,enableNotification:!0});t.attachSelectionChange(this._onRowSelectionChange,this),this._oPlugins=t,this._oTable.addPlugin(t),this._oTable.attachRowSelectionChange(this._onRowSelectionChange,this),this._oTable.attachParseError(this._onPopMsg,this),this._oTable.attachValidationError(this._onPopMsg,this),this.oNavigationHandler=new r(this),this.bOnInitFinished=!0,this.initAppState();var i=new sap.m.Text({text:{parts:[{path:"Status"},{path:"i18n>draft"},{path:"i18n>noAuthorization"},{path:"i18n>blockedCustomer"},{path:"i18n>unchanged"}],formatter:function(e,t,i,a,s){var o;switch(e){case"A":o=i;break;case"B":o=a;break;case"D":o=t;break;case"U":o=s}return o}}});this.oTemplate=new sap.ui.layout.HorizontalLayout({content:[i]}),this._oSmartTable.setIgnoreFromPersonalisation("ConditionRecordUUID,ConditionSequentialNumber,ConditionApplication,CreatedByUser,CreationDate,ConditionTextID,CndnMaxNumberOfSalesOrders,PricingScaleType,PricingScaleBasis,ConditionScaleQuantity,ConditionScaleQuantityUnit,ConditionScaleAmount,ConditionScaleAmountCurrency,ConditionAlternativeCurrency,ConditionTypeName,MainItmMatlPricingGroupName,MainItemPricingRefMaterialName,MaximumConditionBasisValue,MaximumConditionAmount,IncrementalScale,ValidOnDate,AccessNumberOfAccessSequence,ConditionIsDeleted,ETag,ConditionRecordIsEditable,MaterialName,PersonFullName,WorkPackageName,WBSDescription,DistributionChannelName,SalesOrganizationName,PaymentTermsName,EngmtProjectServiceOrgName,CustomerName,PricingScaleLine,WorkItemName,EngagementProjectName,ConditionQuantityUnit,MinimumConditionBasisValue,ConditionCalculationTypeName,DepartureCountryName,SalesDocumentItemText,BillableControlName,IndustryKeyText,CityCodeName,CountyName,ConditionExclusion,TechnicalObjectTypeDesc,EquipmentName,IncotermsClassificationName,CustomerGroupName,CustomerPriceGroupName,SoldToPartyName,PayerPartyName,ShipToPartyName,SupplierName,DestinationCountryName,MaterialGroupName,ReturnsRefundExtentDesc,AdditionalMaterialGroup1Name,AdditionalMaterialGroup2Name,AdditionalMaterialGroup3Name,AdditionalMaterialGroup4Name,AdditionalMaterialGroup5Name,PriceListTypeName,RegionName,TimeSheetOvertimeCategoryText,CommodityCodeText,TaxJurisdictionName,MaterialPricingGroupName,VariantConditionName,SalesOfficeName,SalesGroupName,TransactionCurrencyName,PlantName,SDDocumentCategoryName,DivisionName,SlsOrderSalesOrganizationName,OrderQuantityUnitName,PlantRegionName,ConditionRecordIsDraft,ProductHierarchyNodeText,AccountTaxType,ConsumptionTaxCtrlCode,BRSpcfcTaxBasePercentageCode,BRSpcfcTxGrpDynTaxExceptions,CustomerTaxClassification1,CustomerTaxClassification2,CustomerTaxClassification3,CustomerTaxClassification4,ProductTaxClassification1,ProductTaxClassification2,ProductTaxClassification3,ProductTaxClassification4,TaxJurisdiction,BRSpcfcTaxDepartureRegion,BRSpcfcTaxDestinationRegion,TaxCode,BR_NFDocumentType,BRSpcfcFreeDefinedField1,BRSpcfcFreeDefinedField2,BRSpcfcFreeDefinedField3,TxRlvnceClassfctnForArgentina,BR_TaxCode,LocalSalesTaxApplicabilityCode,ShippingTypeName,ConditionRateValueUnit,ConditionChangeReason,ConditionChangeReasonText,ConditionReleaseStatusText"),this._handleFeature(),this._setCustomerDefaultFilter()},_setCustomerDefaultFilter:function(){var e=this;new sap.ui.model.odata.ODataModel(this.getOwnerComponent().getModel("utils").sServiceUrl,!1).read("ClienteSet",{success:function(t){var i=t.results[0];e._oSmartFilterBar.setFilterData({ConditionType:{items:[],ranges:[{exclude:!1,keyField:"ConditionType",operation:"EQ",tokenText:"=ZP01",value1:"ZP01",value2:""}],value:null},Customer:{items:[],ranges:[{exclude:!1,keyField:"Customer",operation:"EQ",tokenText:"="+i.Kunnr,value1:i.Kunnr,value2:""}],value:null}})},error:function(t){e._showErrorFromOData(t)}})},onExit:function(){this._oMessagePopover&&this._oMessagePopover.destroy()},onBeforeRebindTable:function(e){var t=e.getParameter("bindingParams");void 0===this._oTable.getBinding()&&(this._clearMsg(),this.setModel(this.oMessageManager.getMessageModel(),"message"));var s=[];if(0===t.filters.length&&this.aShowObj.length>0){if(this.iSizeBeforeCreate<=this.aShowObj.length){for(var o=0;o<this.aShowObj.length;o++)s.push(new i("ConditionRecord",a.EQ,this.aShowObj[o]));t.filters.push(new i({filters:s,and:!1}))}return}var r=t.filters;this._parseDateFilter(r,t),0!==r.length&&r[0].aFilters&&this._processNormalFilter(r,t,"ConditionRecord"),this._rebuildFilter(t),this.aBingFilters=t},onSFBAfterVariantLoad:function(e){this._createDynamicaAreaUtil(),this._oDynamicalAreaUtil.aKeyFieldsResult=[];var t=e.getSource().getFilterData().ConditionType;if(void 0!==t){if(this._onGetFilterType(t))return}else this.aTypes=[];var i=e.getSource().getFilterData().ConditionTable;if(void 0!==i){if(this._onGetFilterTable(i))return}else this.aTables=[];this.aTypes.length>0?this.aTables.length>0?this._oDynamicalAreaUtil.setFilterValues([{name:"ConditionType",values:this.aTypes},{name:"ConditionTable",values:this.aTables}]):this._oDynamicalAreaUtil.setFilterValues([{name:"ConditionType",values:this.aTypes}]):this.aTables.length>0?this._oDynamicalAreaUtil.setFilterValues([{name:"ConditionTable",values:this.aTables}]):this._oDynamicalAreaUtil.setFilterValues(),this._oDynamicalAreaUtil.changeDynamicalArea(void 0,void 0,!0),this._setCustomerDefaultFilter()},onSaveVariant:function(e){var t=this._oSmartTable.getUiState(),i=t.getPresentationVariant().Visualizations[0],a=this._oTable._getVisibleColumns(),s=!1;if(i.Content.length!==a.length)s=!0;else{for(var o=[],r=0;r<i.Content.length;r++)o.push(i.Content[r].Value);for(var n=0;n<a.length;n++){var l=a[n].getId().split("-"),h=l[l.length-1];if(-1===o.indexOf(h)){s=!0;break}}}if(s){i.Content=[];for(var d=0;d<a.length;d++){h=(l=a[d].getId().split("-"))[l.length-1];var u={};u.Value=h,i.Content.push(u)}this._oSmartTable.setUiState(t)}},onAssignedFiltersChanged:function(e){var t=this.byId("statusText");if(t&&this._oSmartFilterBar){var i=this._oSmartFilterBar.retrieveFiltersWithValuesAsText();t.setText(i)}},onFilterChange:function(e){if(this._clearMsg(),this.aShowObj=[],this._oPlugins.clearSelection(),this._setTableDisplayed(),!e.getParameter("afterFilterDataUpdate")&&"valueListChanged"!==e.getParameter("sId")&&void 0!==e.getParameter("mParameters")){var t=e.getParameter("mParameters").id.toString().search("ConditionType"),i=e.getParameter("mParameters").id.toString().search("ConditionTable");if(-1!==t||-1!==i){this._createDynamicaAreaUtil();var a=e.getParameter("oSource"),s=this._oResourceBundle.getText("filterNotSupported");if(a.getValueStateText()===s)a.setValueState("None"),a.setValueStateText("");else if("Error"===a.getValueState())return;this._buildDynamicFilter(a,t,i,s)}}},onValueChange:function(e){this._removeMsg(),this._oMessagePopover&&this._oMessagePopover.close(),this._oDraftIndi.clearDraftState(),this.bValueChange=!0;var t=this.getModel(),i=e.getParameter("changeEvent").getSource(),a=i.getDataProperty().typePath,o=i._sBindingContextPath+"/"+a,r=this.oMessageManager.getMessageModel("message").getData(),n=e.getParameter("changeEvent").getParameter("unitChanged");if(n&&"Error"===i.getInnerControls()[1].getValueState()&&(i.getInnerControls()[1].setValue(t.getData(o+"Unit")),i.getInnerControls()[1].setValueState("None"),i.getInnerControls()[1].setValueStateText("")),this.sRateValueField="","Error"===i.getValueState()){var l=!1;for(var h in r)if(r[h].target===o&&r[h].message===i.getValueStateText()){l=!0;break}l||this._addMsg(i.getValueStateText(),s.Error,o,i._sAnnotationLabel),"ConditionRateValue"!==a&&"ConditionLowerLimit"!==a&&"ConditionUpperLimit"!==a?this._popMsg():this.bRateValueError?this._popMsg():(this.sRateValueField=a,i.attachValidationSuccess(this._onRemoveErrorMsg,this)),this.bRateValueError=!1;return}this._removeErrorMsg(r,o),t.bSequentializeRequests=!0,this.bRateValueError=!1,"ConditionRateValue"===a||"ConditionLowerLimit"===a||"ConditionUpperLimit"===a?this.bRateValueUnitchanged=n:this.bRateValueUnitchanged=!1,this._handleValueChange(e)},onSearch:function(e){this.getModel().resetChanges(),this._clearMsg(),this.aShowObj=[],this._oPlugins.clearSelection(),this._setTableDisplayed(),this.bSearch=!0,this.storeCurrentAppState()},onAfterTableVariantSave:function(e){this.storeCurrentAppState()},onCreate:function(e){var t=this.getModel();if(t.resetChanges(),this._clearMsg(),this._oDraftIndi.clearDraftState(),this.iSizeBeforeCreate=this._oTable.getTotalSize(),!this._checkGroup()){var i=this._onBeforeCreate();this._oBusyModel.setProperty("/isBusy",!0),t.setRefreshAfterChange(!1),t.create("/C_SlsPricingConditionRecordTP",i,{success:(function(e){this._setTableEditable(),this.aShowObj.push(e.ConditionRecord),this._switchStatus("Create"),this._oSmartTable.rebindTable(!0),this._onRowSelectionChange(),this._oBusyModel.setProperty("/isBusy",!1)}).bind(this),error:(function(e){this._processOneRequestFail(e)}).bind(this)})}},onImport:function(e){var t=this;sap.ui.core.mvc.XMLView.create({viewName:"zzcus.sd.salesprices.manage.view.Upload",viewData:{controller:this}}).then(function(e){t.getView().addDependent(e),e.byId("uploadDialog").open()})},onExport1:function(e){this.onFileDownload(!1)},onExport2:function(e){this.onFileDownload(!0)},onFileDownload:function(e){var t=this.getModel();t.setRefreshAfterChange(!1),t.setUseBatch(!0),t.setDeferredGroups(["batchExportGroup"]),t.setHeaders({DownloadExcel:"X"}),this._oBusyModel.setProperty("/isBusy",!0),t.read("/C_SlsPricingConditionRecordTP",{filters:this.aBingFilters.filters,groupId:"batchExportGroup",urlParameters:{$top:"1"}});var i=e?"X":"";i=",TextFlag='"+i+"')";var a="/DownloadExcelSet(FilterString='filter',SorterString='"+this._fillDownloadDataSorter(this._oSmartTable)+"'"+i;t.read(a,{groupId:"batchExportGroup"}),this._batchRequestForDownloadData(t)},onFileTemplateDownload:function(){var e=this._oSmartFilterBar.getFilters();if(e.length)var t=this._fillDownloadTemplateFilter(e),i=this._parseTemplateFilterToString(t.aFilterType,t.aFilterTable);else i="";var a="/DownloadExcelTemplateSet(FilterString='"+i+"')/$value",s=this.getOwnerComponent().getModel().sServiceUrl+a;sap.m.URLHelper.redirect(s,!1)},onHistory:function(e){this.storeCurrentAppState(),this.getRouter().navTo("history")},onEdit:function(e){this._clearMsg(),this._oDraftIndi.clearDraftState();var t=this._oTable.getBinding();if(void 0===t||0===t.getLength()){this._addMsg(this._oResourceBundle.getText("noDataFoundText"),s.Information),this._popMsg();return}if(!this._checkGroup()){this._oBusyModel.setProperty("/isBusy",!0);var i=this.getModel();i.setRefreshAfterChange(!1);var a=this._buildEditData();if(a.bEdit)i.callFunction("/AE3B72B4F1AA3073D427AEditconditionrecord",{method:"POST",urlParameters:{ConditionRecordUUID:a.sRecordUUIDs,IsActiveEntity:!0,Preservechanges:!0,Totalcount:a.iRequestTotalCount},success:(function(e,t){this._clearMsg();var i=[],a=[],s=[],o=t.headers["sap-message"];o&&this._prepareMessage("noEditAuthority",o,i,a,s),this._setTableEditable(),this._switchStatus("Edit"),this._oSmartTable.rebindTable(!0),this._onRowSelectionChange(),this._showMessage(i,a,s,!1,"createDraftFailText"),this._oBusyModel.setProperty("/isBusy",!1)}).bind(this),error:(function(e){this._processOneRequestFail(e)}).bind(this)});else{this._oBusyModel.setProperty("/isBusy",!1),this._setTableEditable(a.bIsGroup),this._onRowSelectionChange();var o=this._oTable.getContextByIndex(0);void 0!==o&&o.getProperty("IsActiveEntity")&&this._setTableDisplayed(),""!==this.sPopInfo&&(this._addMsg(this._oResourceBundle.getText(this.sPopInfo),s.Information),this._popMsg())}}},onCancel:function(e){this._clearMsg(),this._oDraftIndi.clearDraftState(),sap.m.MessageBox.warning(this.getText("cancelQuestionText"),{actions:[sap.m.MessageBox.Action.DELETE,sap.m.MessageBox.Action.CANCEL],onClose:(function(e){var t=this.getModel();t.resetChanges();var i=this._oTable.getBinding().getLength();if(e===sap.m.MessageBox.Action.DELETE){this._oBusyModel.setProperty("/isBusy",!0),t.setUseBatch(!0),t.setDeferredGroups(["batchDeleteDraft"]),t.setRefreshAfterChange(!1);for(var a,s=0;s<i;s++){var o=this._oTable.getContextByIndex(s);if(o){var r=o.sPath.search("IsActiveEntity=")+15;"false"===o.sPath.substr(r,5)&&(a=!0,t.remove(o.sPath,{groupId:"batchDeleteDraft"}))}else break}a?t.submitChanges({groupId:"batchDeleteDraft",success:(function(e){this._processSuccess(e,"deleteDraftFailText")}).bind(this),error:(function(e){this._processFail(e)}).bind(this)}):(this._oBusyModel.setProperty("/isBusy",!1),this._setTableDisplayed(),this._switchStatus("Cancel"),this._oSmartTable.rebindTable(!0),this._onRowSelectionChange())}else this._setTableDisplayed(),this._switchStatus("Cancel"),0===Object.keys(this._oSmartFilterBar.getFilterData()).length&&(this.aShowObj=[]),this._oSmartTable.rebindTable(!0),this._onRowSelectionChange()}).bind(this)})},onSave:function(e){if(this._removeMsg(),this._oDraftIndi.clearDraftState(),this._checkBeforeSave()){this._popMsg();return}this.iTotalEditableRecords=0;var t,i=this.getModel();i.setRefreshAfterChange(!1),i.setUseBatch(!0),i.setDeferredGroups(["batchSaveGroup"]),this._oBusyModel.setProperty("/isBusy",!0);for(var a=this._oTable.getBinding().getLength(),s=0;s<a;s++){var o=this._oTable.getContextByIndex(s);if(o){var r=o.sPath.search("IsActiveEntity=")+15,n=o.sPath.substr(r,5);if("false"===n){t=!0,r=o.sPath.search("ConditionRecordUUID=guid'")+25;var l=o.sPath.substr(r,36);i.callFunction("/C_SlsPricingConditionRecordTPActivation",{method:"POST",urlParameters:{ConditionRecordUUID:l,IsActiveEntity:n},groupId:"batchSaveGroup"}),this.iTotalEditableRecords++}}else break}t?(i.bSequentializeRequests=!0,i.submitChanges({groupId:"batchSaveGroup",success:(function(e){this._processSuccess(e,"saveConditionFailText")}).bind(this),error:(function(e){this._processFail(e)}).bind(this)})):(this._oBusyModel.setProperty("/isBusy",!1),this._setTableDisplayed(),this._switchStatus("Save"),this._oSmartTable.rebindTable(!0),this._onRowSelectionChange())},onRequestApprove:function(e){if(this._clearMsg(),this._oDraftIndi.clearDraftState(),!(this._selectRowCheck()||this._checkGroup())){var t=this._buildAQData();this._oBusyModel.setProperty("/isBusy",!0);var i=this.getModel();i.setRefreshAfterChange(!1),t.bSend?(this.aRequestConditions=[],i.callFunction("/C_SlsPricingConditionRecordTPSimulate",{method:"POST",urlParameters:{ConditionRecordUUID:t.sRecordUUIDs,IsActiveEntity:!0,Preservechanges:!0,Totalcount:t.iRequestTotalCount},success:(function(e,i){this._processAQSuccess(i,"requestSimulation",t.bAll)}).bind(this),error:(function(e){this._processOneRequestFail(e)}).bind(this)})):this._oBusyModel.setProperty("/isBusy",!1)}},onSubmitRequest:function(e){if(""===this._oDescription.getValue()&&(this._oDescription.setValueState("Error"),this._oDescription.setValueStateText(this._oResourceBundle.getText("noEntry"))),"None"!==this._oDescription.getValueState())this._oDescription.focus();else{this._closeApproveDialog(),this._clearMsg(),this._oBusyModel.setProperty("/isBusy",!0);for(var t="",i=0;i<this.aRequestConditions.length;i++)t=""===t?this.aRequestConditions[i]:t+","+this.aRequestConditions[i];var a=this.getModel();a.setRefreshAfterChange(!1),a.callFunction("/AE3B72B4F1AA3073D427A3Requestforapproval",{method:"POST",urlParameters:{ConditionRecordUUID:t,IsActiveEntity:!0,Preservechanges:!0,Totalcount:this.aRequestConditions.length},success:(function(e,t){this._processAQSuccess(t,"submitApproval")}).bind(this),error:(function(e){this._processOneRequestFail(e)}).bind(this)})}},onCloseApprove:function(e){this._closeApproveDialog()},onInputChange:function(e){var t=e.getSource();""===t.getValue()?(t.setValueState("Error"),t.setValueStateText(this._oResourceBundle.getText("noEntry"))):(t.setValueState("None"),t.setValueStateText(""))},onCopy:function(e){if(this._clearMsg(),this._oDraftIndi.clearDraftState(),!(this._selectRowCheck()||this._checkActivedata())){if(this.iSizeBeforeCreate=this._oTable.getTotalSize(),!this._checkGroup()){var t,i=this.getModel();i.setRefreshAfterChange(!1),i.setUseBatch(!0),i.setDeferredGroups(["batchCopyGroup"]),this._oBusyModel.setProperty("/isBusy",!0);var a=[];if("true"===this.sSelectAll)for(var o=this._oTable.getBinding().getLength(),r=0;r<o;r++)a.push(r);else a=this._oPlugins.getSelectedIndices();this.sPopInfo="";for(var n=0;n<a.length;n++){var l=this._oTable.getContextByIndex(a[n]);if(l){var h=i.getData(l.sPath);"U"===h.Status?(this._buildCopyData(l),t=!0):"A"===h.Status?this.sPopInfo="copyinfomsg":"B"===h.Status&&(this.sPopInfo="copyinfomsg")}else break}t?i.submitChanges({groupId:"batchCopyGroup",success:(function(e){this._processSuccess(e,"copyConditionFailText")}).bind(this),error:(function(e){this._processFail(e)}).bind(this)}):(this._oBusyModel.setProperty("/isBusy",!1),this._addMsg(this._oResourceBundle.getText(this.sPopInfo),s.Information),this._popMsg())}}},onDelete:function(e){if(this._clearMsg(),this._oDraftIndi.clearDraftState(),!(this._selectRowCheck()||this._checkGroup())){if(!this._checkDeleteData()){this._addMsg(this._oResourceBundle.getText("deleteWFerror"),s.Error),this._popMsg();return}sap.m.MessageBox.warning(this._oResourceBundle.getText("deleteConditionText"),{title:this._oResourceBundle.getText("delete"),actions:[sap.m.MessageBox.Action.DELETE,sap.m.MessageBox.Action.CANCEL],onClose:(function(e){e===sap.m.MessageBox.Action.DELETE&&this._deleteConditions()}).bind(this)})}},onDataReceived:function(e){var t=this._oTable.getBinding().iTotalSize;if(this.iTotalRecords=t,-1===t&&this.bSearch){this.bSearch=!1,this._oSmartTable.rebindTable(!0);return}if(this.bSearch=!1,"0"===t||t<=0){this._setTableDisplayed();var i=e.getParameter("mParameters").data;void 0!==i&&void 0!==i.__batchResponses[0].headers["sap-message"]&&this._popMsg()}else if(this._oSmartTable.getEditable()){var a=this._oTable.getContextByIndex(0);void 0!==a&&a.getProperty("IsActiveEntity")&&this._setTableDisplayed()}this._setColumnWidth(),this._oTable.setRowHeight(this.iRowHeight)},onInitSmartTable:function(e){for(var t=["Material","Customer","ConditionValidityStartDate","ConditionValidityEndDate","Material_fc","MaterialName","Customer_fc","CustomerName","ZZKUNZR","ZZ1_KUNZR_PCHF","ConditionValidityStartDate_fc","ConditionValidityEndDate_fc","ConditionRateValue","ConditionRateValue_fc","ConditionRateValueUnit","ConditionQuantity","ConditionQuantity_fc","ConditionQuantityUnit","IsActiveEntity","DraftEntityLastChangeDateTime","ConditionRecordIsDraft","ConditionRateValueUnit_fc","ConditionQuantityUnit_fc","AdditionalMaterialGroup1","AdditionalMaterialGroup1_fc","AdditionalMaterialGroup1Name"],i=this._oTable.getColumns(),a=0;a<i.length;a++){var s=i[a].getId().split("-"),o=s[s.length-1];-1!==t.indexOf(o)?i[a].setVisible(!0):i[a].setVisible(!1)}},onInitSmartFilterBar:function(e){this.bFilterBarInitialized=!0,this.initAppState();var t=this._oSmartFilterBar.getAllFilterItems();for(var i in t)("DraftAdministrativeData"===t[i].getGroupName()||"ConditionIsExclusive"===t[i].getName())&&t[i].setVisible(!1)},initAppState:function(){if(this.bFilterBarInitialized&&this.bOnInitFinished){var e=this.oNavigationHandler.parseNavigation(),t=this;e.done((function(e,i,a){if(a!==sap.ui.generic.app.navigation.service.NavType.initial){var s=e&&e.bNavSelVarHasDefaultsOnly,o=new sap.ui.generic.app.navigation.service.SelectionVariant(e.selectionVariant),r=o.getParameterNames().concat(o.getSelectOptionsPropertyNames());if(a!==sap.ui.generic.app.navigation.service.NavType.URLParams||1!==r.length||"openMode"!==r[0]){for(var l=new n({selectionVariant:JSON.parse(e.selectionVariant),semanticDates:e.semanticDates}),h=0;h<r.length;h++)t._oSmartFilterBar.addFieldToAdvancedArea(r[h]);s&&""!==t._oSmartFilterBar.getCurrentVariantId()||(t._oSmartFilterBar.clearVariantSelection(),t._oSmartFilterBar.clear(),t._oSmartFilterBar.setUiState(l,{replace:!0,strictMode:!1})),e.tableVariantId&&t._oSmartTable.setCurrentVariantId(e.tableVariantId),t.restoreCustomAppStateData(e.customData),this._setFilterFromRestore(e,t),this._oDynamicalAreaUtil.changeDynamicalArea(!0)}}}).bind(this)),e.fail(function(e){t._handleError(e)})}},storeCurrentAppState:function(){var e=this.oNavigationHandler.storeInnerAppState(this.getCurrentAppState());return e.done(function(e){}),e.fail((function(e){this._handleError(e)}).bind(this)),e},getCurrentAppState:function(){return{selectionVariant:new sap.ui.generic.app.navigation.service.SelectionVariant(JSON.stringify(this._oSmartFilterBar.getUiState().getSelectionVariant())).toJSONString(),tableVariantId:this._oSmartTable.getCurrentVariantId(),customData:this.getCustomAppStateData(),semanticDates:this._oSmartFilterBar.getUiState().getSemanticDates()}},getCustomAppStateData:function(){return{}},restoreCustomAppStateData:function(e){},_setFilterFromRestore:function(e){if(void 0!==e.oSelectionVariant){if(this.aTypes=[],this.aTables=[],void 0!==e.oSelectionVariant.getSelectOption("ConditionType"))for(var t=0;t<e.oSelectionVariant.getSelectOption("ConditionType").length;t++)this.aTypes.push({key:e.oSelectionVariant.getSelectOption("ConditionType")[t].Low});if(void 0!==e.oSelectionVariant.getSelectOption("ConditionTable"))for(var i=0;i<e.oSelectionVariant.getSelectOption("ConditionTable").length;i++)this.aTables.push({key:e.oSelectionVariant.getSelectOption("ConditionTable")[i].Low});this._oBusyModel.setProperty("/isBusy",!0),this._createDynamicaAreaUtil(),this.aTypes.length>0?this.aTables.length>0?this._oDynamicalAreaUtil.setFilterValues([{name:"ConditionType",values:this.aTypes},{name:"ConditionTable",values:this.aTables}]):this._oDynamicalAreaUtil.setFilterValues([{name:"ConditionType",values:this.aTypes}]):this.aTables.length>0?this._oDynamicalAreaUtil.setFilterValues([{name:"ConditionTable",values:this.aTables}]):this._oDynamicalAreaUtil.setFilterValues()}},_selectRowCheck:function(){return this._oPlugins.getSelectedIndices().length<1&&(this._addMsg(this._oResourceBundle.getText("selectConditionText"),s.Error),this._popMsg(),!0)},_deleteConditions:function(){this.iTotalEditableRecords=0,this._clearMsg(),this._oDraftIndi.clearDraftState(),this._oBusyModel.setProperty("/isBusy",!0);var e=this.getModel();e.setRefreshAfterChange(!1),e.setUseBatch(!0),e.setDeferredGroups(["batchDeleteCondition"]);var t=[];if("true"===this.sSelectAll)for(var i=this._oTable.getBinding().getLength(),a=0;a<i;a++)t.push(a);else t=this._oPlugins.getSelectedIndices();var o=this._prepareDeleteData(t);o.bDelete&&e.callFunction("/AE3B72B4F1AA3073D42Deleteconditionrecord",{method:"POST",urlParameters:{ConditionRecordUUID:o.sRecordUUIDs,IsActiveEntity:!0,Preservechanges:!0,Totalcount:o.iRequestTotalCount},groupId:"batchDeleteCondition"}),o.bDeleteSend?e.submitChanges({groupId:"batchDeleteCondition",success:(function(e){this._processSuccess(e,"deleteConditionFail")}).bind(this),error:(function(e){this._processFail(e)}).bind(this)}):(this._oBusyModel.setProperty("/isBusy",!1),this._addMsg(this._oResourceBundle.getText(this.sPopInfo),s.Information),this._popMsg())},_onRowSelectionChange:function(e){e&&e.getParameter("selectAll")&&!0===e.getParameter("selectAll")?this.sSelectAll="true":this.sSelectAll="false";var t=this._oSmartTable.getEditable(),i=this._oPlugins.getSelectedIndices();!t&&i.length>0&&this._checkSelectedData()},_getDraftStatus:function(){this._oDraftStatus||(this._oDraftStatus=this._oSmartFilterBar.getControlByKey("EditingStatus"))},_getFilterMethod:function(){this._oFilterMethod||(this._oFilterMethod=this._oSmartFilterBar.getControlByKey("FilterMethod"))},_onRequestSent:function(e){"MERGE"===e.getParameter("requests")[0].method&&!0===this.bValueChange&&this._oDraftIndi.showDraftSaving(),this.getModel().bSequentializeRequests=!1,this.bValueChange=!1},_onRequestCompleted:function(e){if("MERGE"===e.getParameter("requests")[0].method){var t=this.getModel(),i=e.getParameter("requests")[0].url.split("?")[0];if(!0===e.getParameter("requests")[0].success)this.bTableChange&&this._oDynamicalAreaUtil.changeDynamicalArea(void 0,!0),(this.bQuantityUnitChange||this.bMaterialChange||this.bCalculationType||this.bRateValueUnitchanged)&&(this._oBusyModel.setProperty("/isBusy",!0),t.createBindingContext("/"+i,null,null,this._refectEntry.bind(this),!0),this._clearValueState(i)),this._oDraftIndi.showDraftSaved();else{this._oDraftIndi.clearDraftState();var a=this.oMessageManager.getMessageModel("message").getData();for(var s in a)a[s].technical&&void 0!==a[s].technicalDetails&&this.oMessageManager.removeMessages(a[s])}this.bTableChange=!1,this.bQuantityUnitChange=!1,this.bMaterialChange=!1,this.bCalculationType=!1,this.bRateValueUnitchanged=!1}},_onRequestFailed:function(e){if("MERGE"===e.getParameter("requests")[0].method){var t=this.getModel(),i=e.getParameter("requests")[0].url.split("?")[0],a=t.getPendingChanges()[i];void 0!==a&&void 0!==a.ConditionRateValue?this._truncateRateValue(a,i,"ConditionRateValue"):void 0!==a&&void 0!==a.ConditionLowerLimit?this._truncateRateValue(a,i,"ConditionLowerLimit"):void 0!==a&&void 0!==a.ConditionUpperLimit&&this._truncateRateValue(a,i,"ConditionUpperLimit")}},_refectEntry:function(e){this._oBusyModel.setProperty("/isBusy",!1)},_createDynamicaAreaUtil:function(){this._oDynamicalAreaUtil||(this._oDynamicalAreaUtil=new o(this._oSmartFilterBar,this._oSmartTable,this._oBusyModel),this._oDynamicalAreaUtil.setDataSource(this.getOwnerComponent().getModel(),"/I_SlsPrcgKeyCombinationField"))},_checkActivedata:function(){for(var e=this._oPlugins.getSelectedIndices(),t=[],i=0;i<e.length;i++){var a=this._oTable.getContextByIndex(e[i]);if(a){var o=a.sPath,r=o.search("IsActiveEntity=")+15;if("true"!==o.substr(r,4)){var n=this.getModel().getData(o).ConditionRecord;t.push(n)}}else break}return t.length>0&&(this._oBusyModel.setProperty("/isBusy",!1),this._addMsg(this._oResourceBundle.getText("activeActionFailText"),s.Error),this._popMsg(),!0)},_processSuccess:function(e,t){this._clearMsg();var i=e.__batchResponses[0].__changeResponses;if(!i){this._handleResopnseError(e.__batchResponses[0].response.body);return}var a=!1,s=[],o=[],r=[];if("saveConditionFailText"===t){a=!0,this._setTableDisplayed();var n=[],l=i[0].headers["sap-message"];l&&this._prepareMessage("noSaveAuthority",l,s,o,r,n),this._switchStatus("Save"),!0===this.bApproveFeature&&n.length>0&&(this.aRequestConditions=[],this._triggerSaveWF(n))}else if("copyConditionFailText"===t){this._setTableEditable();for(var h=0;h<i.length;h++)this.aShowObj.push(i[h].data.ConditionRecord);this._switchStatus("Copy")}else"deleteDraftFailText"===t?(this._setTableDisplayed(),this._switchStatus("Cancel")):"deleteConditionFail"===t&&(a=!0,(l=i[0].headers["sap-message"])&&this._prepareMessage("noDeleteAuthority",l,s,o,r));this._oSmartTable.rebindTable(!0),this._onRowSelectionChange(),this._showMessage(s,o,r,a,t),this._oBusyModel.setProperty("/isBusy",!1)},_processAQSuccess:function(e,t,i){this._clearMsg();var a=e.headers["sap-message"];if(a){if(this._oBusyModel.setProperty("/isBusy",!1),"requestSimulation"===t){var o=JSON.parse(a),r=o.message.split("/"),n=[],l=[];r.length>1&&(l.push(r[0]),n.push(r[1]));for(var h=0;h<o.details.length;h++)(r=o.details[h].message.split("/")).length>1&&(-1===l.indexOf(r[0])&&l.push(r[0]),-1===n.indexOf(r[1])&&n.push(r[1]));n.length>0?(this.aRequestConditions=l,this._createApproveDialog("requestApprove",n.length,i)):(this._oSmartTable.rebindTable(!0),this._onRowSelectionChange())}else if("submitApproval"===t){this._oSmartTable.rebindTable(!0),this._onRowSelectionChange(),o=JSON.parse(a);var d=[];for(d.push(o.message),h=0;h<o.details.length;h++)-1===d.indexOf(o.details[h].message)&&d.push(o.details[h].message);for(h=0;h<d.length;h++){var u=this._oResourceBundle.getText("submitRequestText",d[h]);this._addMsg(u,s.Information)}this._popMsg()}}},_processFail:function(e){this._oBusyModel.setProperty("/isBusy",!1),this._clearMsg();var t=$(e.responseText).find("message").first().text();""!==t&&(this._addMsg(t,s.Error),this._popMsg())},_processOneRequestFail:function(e){this._oBusyModel.setProperty("/isBusy",!1),this._clearMsg();try{var t=$(e.responseText).find("message").first().text();""!==t&&(this._addMsg(t,s.Error),this._popMsg())}catch(i){this._handleResopnseError(e.responseText)}},_setTableEditable:function(e){if(this._clearMsg(),!this._oSmartTable.getEditable()&&!e){var t=this.getModel();t.setUseBatch(!0),t.setRefreshAfterChange(!1),t.setDeferredGroups(["batchDraft"]),this._oBusyModel.setProperty("/isVisible",!0),this._oSmartTable.setEditable(!0),t.attachBatchRequestSent(this._onRequestSent,this),t.attachBatchRequestCompleted(this._onRequestCompleted,this),t.attachBatchRequestFailed(this._onRequestFailed,this)}this._oDynamicPage.getShowFooter()||this._oDynamicPage.setShowFooter(!0)},_setTableDisplayed:function(){if(this._oDraftIndi.clearDraftState(),this._oSmartTable.getEditable()){this._oBusyModel.setProperty("/isVisible",!1),this._oSmartTable.setEditable(!1);var e=this.getModel();e.detachBatchRequestSent(this._onRequestSent,this),e.detachBatchRequestCompleted(this._onRequestCompleted,this),e.detachBatchRequestFailed(this._onRequestFailed,this)}this._oDynamicPage.getShowFooter()&&0===this.oMessageManager.getMessageModel("message").getData().length&&this._oDynamicPage.setShowFooter(!1)},_setMessageType:function(e){var t;return"info"===e?s.Information:"warning"===e?s.Warning:s.Success},_draftExist:function(e){for(var t=this._oResourceBundle.getText("warningTextFirst")+" \n ",i=0;i<e.length;i++)t=t+" \n "+e[i];t=t+" \n \n "+this._oResourceBundle.getText("warningTextLast"),sap.m.MessageBox.warning(t,{actions:[this._oResourceBundle.getText("edit"),sap.m.MessageBox.Action.CANCEL],onClose:(function(e){e===this._oResourceBundle.getText("edit")&&this._takeOverDraft()}).bind(this),initialFocus:this._oResourceBundle.getText("edit")})},_takeOverDraft:function(){this._clearMsg(),this._oBusyModel.setProperty("/isBusy",!0);var e=this.getModel();e.setRefreshAfterChange(!1);var t=this._buildEditData();e.callFunction("/AE3B72B4F1AA3073D427AEditconditionrecord",{method:"POST",urlParameters:{ConditionRecordUUID:t.sRecordUUIDs,IsActiveEntity:!0,Preservechanges:!1,Totalcount:t.iRequestTotalCount},success:(function(e){if(this._clearMsg(),!e.__batchResponses[0].__changeResponses){this._handleResopnseError(e.__batchResponses[0].response.body);return}this._switchStatus("Edit"),this._takeOverCreateDraft()}).bind(this),error:(function(e){this._processOneRequestFail(e)}).bind(this)})},_takeOverCreateDraft:function(){this._clearMsg();var e=this.getModel();e.setRefreshAfterChange(!1);var t=this._buildEditData();e.callFunction("/AE3B72B4F1AA3073D427AEditconditionrecord",{method:"POST",urlParameters:{ConditionRecordUUID:t.sRecordUUIDs,IsActiveEntity:!0,Preservechanges:!1,Totalcount:t.iRequestTotalCount},success:(function(e,t){this._clearMsg();var i=[],a=[],s=[],o=t.headers["sap-message"];o&&this._prepareMessage("noEditAuthority",o,i,a,s),this._setTableEditable(),this._oSmartTable.rebindTable(!0),this._onRowSelectionChange(),this._showMessage(i,a,s,!1,"createDraftFailText"),this._oBusyModel.setProperty("/isBusy",!1)}).bind(this),error:(function(e){this._processOneRequestFail(e)}).bind(this)})},_setColumnWidth:function(){this._createDynamicaAreaUtil();for(var e=this._oDynamicalAreaUtil.iKeyFieldsNumber+this._oDynamicalAreaUtil.aDefaultColumns.length,t=2;t<e;t++)t!==this._oDynamicalAreaUtil.iKeyFieldsNumber+2&&t!==this._oDynamicalAreaUtil.iKeyFieldsNumber+3&&t!==this._oDynamicalAreaUtil.iKeyFieldsNumber+4&&this._oTable.autoResizeColumn(t);""!==this.vQuantityPos&&this._oTable.getColumns()[this.vQuantityPos].setWidth("200px"),""!==this.vConditionTablePos&&this._oTable.getColumns()[this.vConditionTablePos].setWidth("120px"),""!==this.vEditStatusPos&&this._oTable.getColumns()[this.vEditStatusPos].setWidth("160px"),""!==this.vConditionLowerLimitPos&&this._oTable.getColumns()[this.vConditionLowerLimitPos].setWidth("160px"),""!==this.vConditionUpperLimitPos&&this._oTable.getColumns()[this.vConditionUpperLimitPos].setWidth("160px"),this._oTable.autoResizeColumn(0)},_buildEditData:function(){var e={bEdit:!1,iRequestTotalCount:0,sRecordUUIDs:"",bIsGroup:!0},t=this.getModel();this.sPopInfo="";for(var i=this._oTable.getBinding().getLength(),a=0;a<i;a++){var s=this._oTable.getContextByIndex(a);if(s){var o=t.getData(s.sPath);if("U"===o.Status){e.bEdit=!0,e.iRequestTotalCount=e.iRequestTotalCount+1;var r=s.sPath.search("ConditionRecordUUID=guid'")+25,n=s.sPath.substr(r,36);""===e.sRecordUUIDs?e.sRecordUUIDs=n:e.sRecordUUIDs=e.sRecordUUIDs+","+n}else"A"===o.Status?this.sPopInfo="editinfomsg":"B"===o.Status&&(this.sPopInfo="editinfomsg");void 0!==o.ConditionRecord&&(e.bIsGroup=!1)}else break}return e},_switchStatus:function(e){this._getDraftStatus();var t=this._oDraftStatus.getSelectedKey();switch(t){case"ownDraft":("Save"===e||"Cancel"===e)&&this._oDraftStatus.setSelectedKey("all");break;case"unchanged":("Create"===e||"Edit"===e||"Copy"===e||"Save"===e||"Cancel"===e)&&this._oDraftStatus.setSelectedKey("all")}},_checkGroup:function(){return this._oTable.getGroupedColumns().length>0&&(this._addMsg(this._oResourceBundle.getText("actionNotAllowed"),s.Error),this._popMsg(),!0)},_checkBeforeSave:function(){var e=!1,t=this.oMessageManager.getMessageModel("message").getData();for(var i in t)if(t[i].controlIds.length>0){e=!0;break}return e},_onBeforeCreate:function(){var e={};e.ConditionSequentialNumber="01";var t=this._oSmartFilterBar.getFilterData().ConditionType;if(void 0!==t&&!1===this._onGetFilterType(t)){var i=[];for(var a in this.aTypes)-1===i.indexOf(this.aTypes[a].key)&&i.push(this.aTypes[a].key);1===i.length&&(e.ConditionType=i[0])}var s=this._oSmartFilterBar.getFilterData().ConditionTable;if(void 0!==s&&!1===this._onGetFilterTable(s)){var o=[];for(var r in this.aTables)-1===o.indexOf(this.aTables[r].key)&&o.push(this.aTables[r].key);1===o.length&&(e.ConditionTable=o[0])}if(this._oDynamicalAreaUtil)for(var n=0;n<this._oDynamicalAreaUtil.aFilterFields.length;n++)this._setDefaultVakey(e,this._oDynamicalAreaUtil.aFilterFields[n]);return e},_onGetFilterType:function(e){var t=!0;if(0===e.items.length&&0===e.ranges.length)return t;t=!1,this.aTypes.splice(0,this.aTypes.length);for(var i=0;i<e.items.length;i++)this.aTypes.push(e.items[i]);for(var a=0;a<e.ranges.length;a++)if(!1===e.ranges[a].exclude&&"EQ"===e.ranges[a].operation)this.aTypes.push({key:e.ranges[a].value1,text:""});else{this.aTypes=[],t=!0;break}return t},_onGetFilterTable:function(e){var t=!0;if(0===e.items.length&&0===e.ranges.length)return t;t=!1,this.aTables.splice(0,this.aTables.length);for(var i=0;i<e.items.length;i++)this.aTables.push(e.items[i]);for(var a=0;a<e.ranges.length;a++)if(!1===e.ranges[a].exclude&&"EQ"===e.ranges[a].operation)this.aTables.push({key:e.ranges[a].value1,text:""});else{this.aTables=[],t=!0;break}return t},_onRemoveErrorMsg:function(e){var t=e.getSource().getParent().getParent(),i=this.oMessageManager.getMessageModel("message").getData();if(""!==this.sRateValueField){var a=t._sBindingContextPath+"/"+this.sRateValueField;this._removeErrorMsg(i,a),t.detachValidationSuccess(this._onRemoveErrorMsg,this),this.sRateValueField=""}},_removeErrorMsg:function(e,t){for(var i in e)e[i].target===t&&this.oMessageManager.removeMessages(e[i])},_removeErrorState:function(){var e=this._oSmartFilterBar.getControlByKey("ConditionType"),t=this._oSmartFilterBar.getControlByKey("ConditionTable");"Error"===e.getValueState()&&(e.setValue(""),e.setValueState("None"),e.setValueStateText("")),"Error"===t.getValueState()&&(t.setValue(""),t.setValueState("None"),t.setValueStateText(""))},_onPopMsg:function(e){var t=e.getSource().getParent().getParent().getAssociation("ariaLabelledBy").toString().search("ConditionRateValue"),i=e.getSource().getParent().getParent().getAssociation("ariaLabelledBy").toString().search("ConditionLowerLimit"),a=e.getSource().getParent().getParent().getAssociation("ariaLabelledBy").toString().search("ConditionUpperLimit");(-1!==t||-1!==i||-1!==a)&&(this.bRateValueError=!0)},_handleError:function(e){},_batchRequestForDownloadData:function(e){this._clearMsg(),this._oDraftIndi.clearDraftState(),e.submitChanges({groupId:"batchExportGroup",success:(function(t,i){if(e.setHeaders({DownloadExcel:""}),this._oBusyModel.setProperty("/isBusy",!1),i&&i.data&&i.data.__batchResponses[1]&&i.data.__batchResponses[1].data&&i.data.__batchResponses[1].data.ExcelName&&"#"!==i.data.__batchResponses[1].data.ExcelName){for(var a=i.data.__batchResponses[1].data.ExcelName,s=atob(i.data.__batchResponses[1].data.ExcelContent),o=Array(s.length),r=0;r<s.length;r++)o[r]=s.charCodeAt(r);var n=new Uint8Array(o),l=new Blob([n],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});if(sap.ui.Device.browser.msie)window.navigator.msSaveOrOpenBlob(l,a);else{var h=window.document.createElement("a"),d=window.URL.createObjectURL(l);h.href=d,h.download=a,h.click()}}else this._downloadErrorHandling(t)}).bind(this),error:(function(t,i){e.setHeaders({DownloadExcel:""}),this._processFail(t)}).bind(this)})},_fillDownloadDataSorter:function(e){var t=e._getTablePersonalisationData();if(t){var i=t.sorters,a=sap.ui.model.odata.ODataUtils.createSortParams(i);a=a?a.slice(9):""}else a="";return a},_filterToString:function(e,t){var i=t.getMetaModel().getODataEntityType("SD_PRICING_CONDITIONRECORD_SRV.C_SlsPricingConditionRecordTP"),a=t.getServiceMetadata();return sap.ui.model.odata.ODataUtils.createFilterParams(e,a,i)},_fillDownloadTemplateFilter:function(e){var t=[],i=[],a=[];for(t.push(e[0]);0!==t.length;){var s=t.pop();if(s.aFilters)for(var o=s.aFilters.length-1;o>=0;o--)t.push(s.aFilters[o]);else"ConditionType"===s.sPath&&(s.oValue1&&(s.oValue1=s.oValue1.replace(/\'+/,""),s.oValue1=s.oValue1.replace(/\'+/,""),s.oValue1="''"+s.oValue1+"''"),a.push(s)),"ConditionTable"===s.sPath&&(s.oValue1&&(s.oValue1=s.oValue1.replace(/\'+/,""),s.oValue1=s.oValue1.replace(/\'+/,""),s.oValue1="''"+s.oValue1+"''"),i.push(s))}return{aFilterType:a,aFilterTable:i}},_parseDateFilter:function(e,t){var s=[];if(0!==e.length){var o=null;if(e[0].aFilters){for(var r in e[0].aFilters)if(void 0!==e[0].aFilters[r].sPath&&"ValidOnDate"===e[0].aFilters[r].sPath){o=e[0].aFilters[r],e[0].aFilters.splice(r,1);break}}else"ValidOnDate"===e[0].sPath&&(o=e[0],e.shift());o&&(s.push(new i("ConditionValidityStartDate",a.LE,o.oValue1)),s.push(new i("ConditionValidityEndDate",a.GE,o.oValue1)),t.filters.push(new i({filters:s,and:!0})))}0!==e.length&&this._processValidityDate(e,t,s)},_processValidityDate:function(e,t,a){var s=null,o=null;if(e[0].aFilters)for(var r in e[0].aFilters)void 0!==e[0].aFilters[r].sPath&&"ConditionValidityStartDate"===e[0].aFilters[r].sPath&&(s=e[0].aFilters[r],e[0].aFilters.splice(r,1));else"ConditionValidityStartDate"===e[0].sPath&&(s=e[0],e.shift());if(e[0].aFilters)for(r in e[0].aFilters)void 0!==e[0].aFilters[r].sPath&&"ConditionValidityEndDate"===e[0].aFilters[r].sPath&&(o=e[0].aFilters[r],e[0].aFilters.splice(r,1),0===e[0].aFilters.length&&e.shift());else"ConditionValidityEndDate"===e[0].sPath&&(o=e[0],e.shift());if(s||o){var n=[];0===a.length&&s&&n.push(s),0===a.length&&o&&n.push(o),0!==n.length&&t.filters.push(new i({filters:n,and:!0}))}},_processNormalFilter:function(e,t,a){var s,o=null;for(var r in e[0].aFilters){if(e[0].aFilters[r].aFilters&&e[0].aFilters[r].aFilters[0].sPath===a){"0"===r&&e[0].aFilters.length>1&&e[0].aFilters[1].aFilters&&e[0].aFilters[1].aFilters[0].sPath===a?(o=e[0].aFilters,s=e[0].bAnd,e.shift()):(o=e[0].aFilters[r].aFilters,s=e[0].aFilters[r].bAnd,e[0].aFilters.splice(r,1),0===e[0].aFilters.length&&e.shift());break}if(e[0].aFilters[r].aFilters&&e[0].aFilters[r].aFilters[0].aFilters&&e[0].aFilters[r].aFilters[0].aFilters[0].sPath===a)o=e[0].aFilters[r].aFilters,s=e[0].aFilters[r].bAnd,e[0].aFilters.splice(r,1),0===e[0].aFilters.length&&e.shift();else if(e[0].aFilters[r].sPath&&e[0].aFilters[r].sPath===a){o=e[0].aFilters,s=e[0].bAnd,e.shift();break}}o&&t.filters.push(new i({filters:o,and:s}))},_parseFilterMethod:function(e,t){if(this._oDynamicalAreaUtil&&this._oDynamicalAreaUtil.aKeyFieldsResult.length>0&&0!==this.aTypes.length)for(var s={},o=0;o<this._oDynamicalAreaUtil.aKeyFieldsResult.length;o++){var r=this._oDynamicalAreaUtil.aKeyFieldsResult[o];r&&!s[r.ConditionType]?(s[r.ConditionType]={},s[r.ConditionType][r.ConditionTable]=Array(r.ConditionFieldName)):r&&!s[r.ConditionType][r.ConditionTable]?s[r.ConditionType][r.ConditionTable]=Array(r.ConditionFieldName):r&&-1===s[r.ConditionType][r.ConditionTable].indexOf(r.ConditionFieldName)&&s[r.ConditionType][r.ConditionTable].push(r.ConditionFieldName)}if(s&&0!==Object.getOwnPropertyNames(s).length&&0!==e.length){var n=[],l=[];for(o=0;o<e[0].aFilters.length;o++){var h=e[0].aFilters[o];if(h.aFilters&&"ConditionType"!==h.aFilters[0].sPath&&"ConditionTable"!==h.aFilters[0].sPath&&"ValidOnDate"!==h.aFilters[0].sPath&&"ConditionRecord"!==h.aFilters[0].sPath)for(var d=0;d<h.aFilters.length;d++){var u=[h.aFilters[d].sPath,h.aFilters[d].sOperator,h.aFilters[d].oValue1,h.aFilters[d].oValue2];l.push(u)}}var c=Object.getOwnPropertyNames(s).toString(),g=l.toString();for(o=0;o<this.aTypes.length;o++){var p=[];if(p.push(new i("ConditionType",a.EQ,this.aTypes[o].key)),-1!==c.indexOf(this.aTypes[o].key)){for(d=0;d<Object.getOwnPropertyNames(s[this.aTypes[o].key]).length;d++){var f=Object.getOwnPropertyNames(s[this.aTypes[o].key])[d];p.push(new i("ConditionTable",a.EQ,f));var m=s[this.aTypes[o].key][f];this._buildCombineFilter(m,g,l,p),n.push(new i({filters:p,and:!0})),p=Array(new i("ConditionType",a.EQ,this.aTypes[o].key))}p.push(new i("ConditionTable",a.EQ,"")),n.push(new i({filters:p,and:!0}))}}e.shift(),t.filters.push(new i({filters:n,and:!1}))}},_buildCombineFilter:function(e,t,a,s){for(var o in e)if(-1!==t.indexOf(e[o])){var r=[];for(var n in a)e[o]===a[n][0]&&r.push(new i(a[n][0],a[n][1],a[n][2],a[n][3]));0!==r.length&&s.push(new i({filters:r,and:!1}))}},_rebuildFilter:function(e){if(this.aShowObj.length>0){var t={};t.aFilters=[],t.bAnd=!0,t._bMultiFilter=!0;for(var s=e.filters.length,o=0;o<s;o++){var r=JSON.parse(JSON.stringify(e.filters[0]));t.aFilters.push(r),o!==s-1&&e.filters.splice(0,1)}for(var n=[],l=0;l<this.aShowObj.length;l++)n.push(new i("ConditionRecord",a.EQ,this.aShowObj[l]));var h={};h.aFilters=n,h.bAND=!1,h.bMultiFilter=!0;var d=[];d.push(t),d.push(h),e.filters[0].aFilters=d,e.filters[0].bAnd=!1}},_buildDynamicFilter:function(e,t,i,a){var s=this._oSmartFilterBar.getFilterData().ConditionType,o=this._oSmartFilterBar.getFilterData().ConditionTable,r=!1;if(void 0!==s){if(this._onGetFilterType(s)&&(0!==s.ranges.length&&-1!==t&&(e.setValueState("Error"),e.setValueStateText(a)),r=!0),void 0!==o){if(this._onGetFilterTable(o)){0!==o.ranges.length&&-1!==i&&(e.setValueState("Error"),e.setValueStateText(a));return}if(r)return;this._oBusyModel.setProperty("/isBusy",!0),this._oDynamicalAreaUtil.setFilterValues([{name:"ConditionType",values:this.aTypes},{name:"ConditionTable",values:this.aTables}]),this._oDynamicalAreaUtil.changeDynamicalArea(),this._removeErrorState()}else{if(r)return;this.aTables.splice(0,this.aTables.length),this._oBusyModel.setProperty("/isBusy",!0),this._oDynamicalAreaUtil.setFilterValues([{name:"ConditionType",values:this.aTypes}]),this._oDynamicalAreaUtil.changeDynamicalArea(),this._removeErrorState()}}else this._processNoConditionType(e,o,i,a)},_processNoConditionType:function(e,t,i,a){if(this.aTypes.length>0)this.aTypes.splice(0,this.aTypes.length),this.aTables.splice(0,this.aTables.length),this._oBusyModel.setProperty("/isBusy",!0),this._oDynamicalAreaUtil.setFilterValues(),this._oDynamicalAreaUtil.changeDynamicalArea(),this._removeErrorState();else if(void 0!==t){if(this._onGetFilterTable(t)){0!==t.ranges.length&&-1!==i&&(e.setValueState("Error"),e.setValueStateText(a));return}this._oBusyModel.setProperty("/isBusy",!0),this._oDynamicalAreaUtil.setFilterValues([{name:"ConditionTable",values:this.aTables}]),this._oDynamicalAreaUtil.changeDynamicalArea(),this._removeErrorState()}else this.aTables.splice(0,this.aTables.length),this._oBusyModel.setProperty("/isBusy",!0),this._oDynamicalAreaUtil.setFilterValues(),this._oDynamicalAreaUtil.changeDynamicalArea(),this._removeErrorState()},_handleValueChange:function(e){var t=this.getModel(),i=e.getParameter("changeEvent").getSource(),a=i.getDataProperty().typePath,s=i._sBindingContextPath+"/"+a,o=e.getParameter("changeEvent").getParameter("unitChanged"),r=e.getParameter("changeEvent").getParameter("newValue");if("Material"===a){this.bMaterialChange=!0;return}if("ConditionCalculationType"===a){this.bCalculationType=!0;return}if("ConditionQuantity"===a&&o){this.bQuantityUnitChange=!0;return}if(("ConditionToBaseQtyNmrtr"===a||"ConditionToBaseQtyDnmntr"===a)&&(0===r.indexOf("-")||0===r||"0,000"===r||"00,000"===r)){t.setProperty(s,i.getProperty("value"));return}this._handleSpecificProperty(a,r,i)},_handleSpecificProperty:function(e,t,i){var a=this.getModel(),s=this.oMessageManager.getMessageModel("message").getData();if("FixedValueDate"===e||"AdditionalValueDays"===e){var o,r=""===t||"0"===t?3:1;"FixedValueDate"===e?(a.setProperty(i._sBindingContextPath+"/AdditionalValueDays_fc",r),o=i._sBindingContextPath+"/AdditionalValueDays"):(a.setProperty(i._sBindingContextPath+"/FixedValueDate_fc",r),o=i._sBindingContextPath+"/FixedValueDate"),1===r&&this._removeErrorMsg(s,o);return}if("ConditionType"===e){var n=i._sBindingContextPath+"/ConditionTable";a.setProperty(n,""),n=i._sBindingContextPath+"/ConditionCalculationType",a.setProperty(n,"")}else"ConditionTable"===e&&this._buildDynamicalColumn(i,t)},_buildDynamicalColumn:function(e,t){var i=this.getModel(),a=e._sBindingContextPath+"/ConditionRecord",s=i.getProperty(a);-1===this.aShowObj.indexOf(s)&&this.aShowObj.push(s),a=e._sBindingContextPath+"/ConditionType";var o=i.getProperty(a);if(""!==t&&""!==o&&null!==o){for(var r=[],n=[],l=[],h=[],d=this._oTable.getBinding().getLength(),u=0;u<d;u++){var c=this._oTable.getContextByIndex(u);if(c){var g=c.sPath.search("IsActiveEntity=")+15;if("true"===c.sPath.substr(g,4))break;var p=c.sPath+"/ConditionType",f=i.getProperty(p);if(""!==f&&-1===h.indexOf(f)){var m={key:f};l.push(m),h.push(f)}p=c.sPath+"/ConditionTable";var y=i.getProperty(p);if(""!==y&&-1===n.indexOf(y)){var C={key:y};r.push(C),n.push(y)}}else break}this._clearMsg(),l.length>0&&r.length>0&&(this._oBusyModel.setProperty("/isBusy",!0),this.bTableChange=!0,this._oDynamicalAreaUtil.setFilterValues([{name:"ConditionType",values:l},{name:"ConditionTable",values:r}]))}},_buildCopyData:function(e){for(var t=this.getModel(),i=Object.assign({},t.getData(e.sPath)),a={},s=0;s<this.aCopyFields.length;s++)void 0!==i[this.aCopyFields[s]]&&(a[this.aCopyFields[s]]=i[this.aCopyFields[s]]);a.ConditionRecord="",a.ConditionSequentialNumber="01",a.ConditionQuantityUnit=i.ConditionQuantityUnit,a.ConditionRateValueUnit=i.ConditionRateValueUnit,t.create("/C_SlsPricingConditionRecordTP",a,{groupId:"batchCopyGroup"})},_prepareDeleteData:function(e){var t,i,a=0,s="",o=[],r=this.getModel();this.sPopInfo="";for(var n=0;n<e.length;n++){var l=this._oTable.getContextByIndex(e[n]);if(l){var h=r.getData(l.sPath);if(this.iTotalEditableRecords++,"D"===h.Status)o.push(l.sPath),i=!0;else if("U"===h.Status){t=!0,a+=1;var d=l.sPath.search("ConditionRecordUUID=guid'")+25,u=l.sPath.substr(d,36);s=""===s?u:s+","+u,i=!0}else this.sPopInfo="deleteinfomsg"}else break}for(var c=0;c<o.length;c++)r.remove(o[c],{groupId:"batchDeleteCondition"});var g={};return g.bDelete=t,g.bDeleteSend=i,g.sRecordUUIDs=s,g.iRequestTotalCount=a,g},_handleResopnseError:function(e){this._oBusyModel.setProperty("/isBusy",!1);for(var t=[],i=[],a=JSON.parse(e).error.innererror.errordetails,o=0;o<a.length;o++)if("/IWBEP/CX_MGW_BUSI_EXCEPTION"!==a[o].code&&"LCX_TECH_EXCEPTION"!==a[o].code){var r=a[o].message.split(",");"Take Over"===r[0]?-1===t.indexOf(r[1].substr(0,10))&&t.push(r[1].substr(0,10)):"error"===a[o].severity&&-1===i.indexOf(a[o].message)&&i.push(a[o].message)}if(i.length>0){for(o=0;o<i.length;o++)this._addMsg(i[o],s.Error,null,null,a[o].longtext_url);this._popMsg()}else this._draftExist(t)},_prepareMessage:function(e,t,i,a,s,o){var r=JSON.parse(t),n=r.message.split(",");if("No Authorization"===n[0])i.push({obj:n[1],text:e}),"noEditAuthority"===e&&this.aShowObj.push(n[1]);else{var l=r.message.split("SimulateWF:");if(void 0!==o&&2===l.length&&""===l[0]?o.push(l[1]):-1===a.indexOf(r.message)&&(a.push(r.message),s.push(r.severity)),"noSaveAuthority"===e&&"PRCG_CNDNRECORD_API/015"===r.code){var h=r.message.substr(17,10);this.aShowObj.push(h)}}for(var d=0;d<r.details.length;d++)"No Authorization"===(n=r.details[d].message.split(","))[0]?(i.push({obj:n[1],text:e}),"noEditAuthority"===e&&this.aShowObj.push(n[1])):(l=r.details[d].message.split("SimulateWF:"),void 0!==o&&2===l.length&&""===l[0]?o.push(l[1]):-1===a.indexOf(r.details[d].message)&&(a.push(r.details[d].message),s.push(r.details[d].severity)),"noSaveAuthority"===e&&"PRCG_CNDNRECORD_API/015"===r.details[d].code&&(h=r.details[d].message.substr(17,10),this.aShowObj.push(h)))},_showMessage:function(e,t,i,a,o){if(e.length>0)for(var r=0;r<e.length;r++){var n=this._oResourceBundle.getText(e[r].text,[e[r].obj]);this._addMsg(n,s.Information)}if(t.length>0)for(r=0;r<t.length;r++)this._addMsg(t[r],this._setMessageType(i[r]));""!==this.sPopInfo&&this._addMsg(this._oResourceBundle.getText(this.sPopInfo),s.Information),this.oMessageManager.getMessageModel("message").getData().length>0&&this._popMsg(),a&&this.iTotalEditableRecords!==e.length&&("saveConditionFailText"===o?sap.m.MessageToast.show(this._oResourceBundle.getText("saveConditionText")):"deleteConditionFail"===o&&sap.m.MessageToast.show(this._oResourceBundle.getText("conditionDeletedText")))},_setDefaultVakey:function(e,t){var i=this._oSmartFilterBar.getFilterData()[t];if(void 0!==i){for(var a=[],s=0;s<i.items.length;s++)a.push(i.items[s]);for(var o=0;o<i.ranges.length;o++)if("EQ"===i.ranges[o].operation)a.push({key:i.ranges[o].value1,text:""});else{a=[];break}var r=[];for(var n in a)-1===r.indexOf(a[n].key)&&r.push(a[n].key);1===r.length&&(e[t]=r[0])}},_downloadErrorHandling:function(e){for(var t=0;t<e.__batchResponses.length;t++){var i=e.__batchResponses[t].response;if(void 0!==i){var a=JSON.parse(i.body),o=a.error.message.value,r=[];r.push(o);for(var n=a.error.innererror.errordetails,l=0;l<n.length;l++)-1===r.indexOf(n[l].message)&&r.push(n[l].message);for(l=0;l<r.length;l++)this._addMsg(r[l],s.Error);this._popMsg()}}},_parseTemplateFilterToString:function(e,t){var i;if(e.length&&(i=(i=this._filterToString(e,this.getOwnerComponent().getModel())).slice(8)),t.length){var a=this._filterToString(t,this.getOwnerComponent().getModel());i=i?"("+i+")%20and%20("+a.slice(8)+")":a.slice(8)}return e.length||t.length||(i=""),i},_createApproveDialog:function(e,t,i){var a=this.getModel();if(this.oApproveDialog=sap.ui.xmlfragment(this.getView().getId(),"zzcus.sd.salesprices.manage.view.Approve",this),this.oApproveDialog.setModel(a),this.getView().addDependent(this.oApproveDialog),this._oDescription=this.byId("descriptionInput"),this._oReason=this.byId("reasonSFI"),this._oApproveMessageStrip=this.byId("approveMessageStrip"),this._oApproveMessageStrip.setVisible(!1),"save"===e){this.byId("skip").setVisible(!0);var s="mulSavedAR"}else this.byId("cancelRequest").setVisible(!0),s="mulSelectedAR";!0===i&&t>1?(s=this._oResourceBundle.getText(s,t),this._oBusyModel.setProperty("/sApproveInfo",s),this._oApproveMessageStrip.setVisible(!0)):!1===i&&1===t?(this._oBusyModel.setProperty("/sApproveInfo",this._oResourceBundle.getText("mulSomeAR")),this._oApproveMessageStrip.setVisible(!0)):!1===i&&t>1&&(s=this._oResourceBundle.getText("mulSomeMoreAR",t),this._oBusyModel.setProperty("/sApproveInfo",s),this._oApproveMessageStrip.setVisible(!0)),a.setDeferredGroups(["doNotSubmit"]),this._oReason.setBindingContext(a.createEntry("/C_SlsPricingConditionRecordTP",{groupId:"doNotSubmit"})),this._oReason.bindProperty("value","ConditionChangeReason"),this.oApproveDialog.open(),this._oDescription.focus()},_closeApproveDialog:function(){this._oDescription.setValue(""),this._oDescription.setValueState("None"),this._oDescription.setValueStateText(""),this.oApproveDialog.close(),this.oApproveDialog.destroy(),this.getModel().deleteCreatedEntry()},_handleFeature:function(){sap.s4h.cfnd.featuretoggle.lib.featuresAsync().then((function(e){this.bApproveFeature=!1}).bind(this))},_buildAQData:function(){var e={bSend:!1,iRequestTotalCount:0,sRecordUUIDs:"",bAll:!0},t=this.getModel(),i=[];if("true"===this.sSelectAll)for(var a=this._oTable.getBinding().getLength(),s=0;s<a;s++)i.push(s);else i=this._oPlugins.getSelectedIndices();for(var o=0;o<i.length;o++){var r=this._oTable.getContextByIndex(i[o]);if(r){var n=t.getData(r.sPath);if("U"===n.Status&&"A"===n.ConditionReleaseStatus){e.bSend=!0,e.iRequestTotalCount=e.iRequestTotalCount+1;var l=r.sPath.search("ConditionRecordUUID=guid'")+25,h=r.sPath.substr(l,36);""===e.sRecordUUIDs?e.sRecordUUIDs=h:e.sRecordUUIDs=e.sRecordUUIDs+","+h}else e.bAll=!1}else break}return e},_triggerSaveWF:function(e){for(var t=[],i=[],a=0;a<e.length;a++){var s=e[a].split("/");s.length>1&&(-1===t.indexOf(s[0])&&t.push(s[0]),-1===i.indexOf(s[1])&&i.push(s[1]))}i.length>0&&(this.aRequestConditions=t,this._createApproveDialog("save",i.length,!0))},_checkSelectedData:function(){var e={bSend:!1,bCopy:!1,bDelete:!1},t=this.getModel(),i=[];if("true"===this.sSelectAll)for(var a=this._oTable.getBinding().getLength(),s=0;s<a;s++)i.push(s);else i=this._oPlugins.getSelectedIndices();for(var o=0;o<i.length;o++){var r=this._oTable.getContextByIndex(i[o]);if(r){var n=t.getData(r.sPath);"U"===n.Status&&(e.bCopy=!0,"A"===n.ConditionReleaseStatus&&(e.bSend=!0)),"D"!==n.ConditionReleaseStatus&&"F"!==n.ConditionReleaseStatus&&(e.bDelete=!0)}else break}return e},_checkDeleteData:function(){var e=!0,t=this.getModel(),i=[];if("true"===this.sSelectAll)for(var a=this._oTable.getBinding().getLength(),s=0;s<a;s++)i.push(s);else i=this._oPlugins.getSelectedIndices();for(var o=0;o<i.length;o++){var r=this._oTable.getContextByIndex(i[o]);if(r){var n=t.getData(r.sPath);if("D"===n.ConditionReleaseStatus||"F"===n.ConditionReleaseStatus){e=!1;break}}else break}return e},_truncateRateValue:function(e,t,i){var a=e[i].split("."),s=!1;if("-"===a[0].substr(0,1)&&(a[0]=a[0].substr(1),s=!0),1===a.length)var o=a[0].length<11?a[0].substr(0,9):a[0].substr(0,11);else o=a[0].substr(0,9)+"."+a[1];s&&(o="-"+o),this.getModel().setProperty("/"+t+"/"+i,o)},_clearValueState:function(e){var t=this.oMessageManager.getMessageModel("message").getData();for(var i in t)null!==t[i].aTargets[0]&&t[i].aTargets[0].split("/")[1]===e&&this.oMessageManager.removeMessages(t[i])},_showErrorFromOData:function(e){try{var t=jQuery.parseXML(e.response.body).querySelector("errordetails message").textContent}catch(i){}t||(t="N\xe3o \xe9 possivel continuar com a execu\xe7\xe3o. Contate o administrador do sistema."),sap.m.MessageBox.error(t)}})});