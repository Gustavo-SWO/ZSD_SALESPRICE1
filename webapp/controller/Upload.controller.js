/*
 * Copyright (C) 2009-2021 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/m/Button","sap/m/Dialog","sap/m/library","sap/m/Text","sap/ui/unified/FileUploaderParameter","./BaseController","sap/m/MessageToast","sap/m/MessageBox"],function(B,D,m,T,F,a,M,b){"use strict";return a.extend("zzcus.sd.salesprices.manage.controller.Upload",{onUploadCancel:function(){this.byId("uploadDialog").close();},onUploadClose:function(){this.byId("uploadDialog").destroy();},onFileUpload:function(){var f=this.getView().byId("fileUploader");f.removeAllHeaderParameters();if((!this.csrfToken)&&f.getValue()){if(f.getValue().length>100){b.error(this.getText("maxFileLength"),{actions:b.Action.CLOSE});}else{this.csrfToken=this.getView().getModel().getSecurityToken();f.setSendXHR(true);var h=new F();h.setName("x-csrf-token");h.setValue(this.csrfToken);f.addHeaderParameter(h);var c=new F();c.setName("slug");var e=encodeURI(f.getValue());c.setValue(e);f.addHeaderParameter(c);f.upload();this.byId("uploadDialog").setBusy(true);}}else{f.setValueState(sap.ui.core.ValueState.Error);f.setValueStateText(this.getText("missingEntry"));}},handleValueChange:function(e){if(e.getParameter("newValue")){this.getView().byId("fileUploader").setValueState(sap.ui.core.ValueState.None);}},onTypeMissMatch:function(){b.error(this.getText("fileUploadTypeMissmatch"));},onUploadComplete:function(e){this.byId("uploadDialog").close();var r=e.getParameters().headers["sap-message"];if(r){var v=this.getText("viewHistory");var R=this.getView().getViewData().controller.getRouter();var c=this._parseResponseAsyn(r);if(c===true){this._showAsynInfo(this.getText("importStarted"),v,R);}else{this._showImportResult(r,v,R);}}this._parseEmptyFileName(e);var V=this._parseVirus(e);if(V){this._showError(V);}},_parseVirus:function(e){var r=e.getParameters().responseRaw;var c=/<message>(.+?)<\/message>/g;var d=r.match(c);if(d&&r.indexOf("PRCG_CNDNRECORD_API/091")>0){return d[0].replace("<message>","").replace("<\/message>","");}return null;},_parseEmptyFileName:function(e){if(e.getParameters().response.search("PRCG_CNDNRECORD_API/107")!==-1){b.error(this.getText("uploadFileNameEmpty"),{actions:b.Action.CLOSE});}},_parseResponse:function(r){var c=/<message>(.+?)<\/message>/g;var d=r.match(c);if(d&&d.length===3){var f=d[1].toString().match(/-?[0-9]\d*-?/g).toString();var s=d[2].toString().match(/-?[0-9]\d*-?/g).toString();var u=d[0].toString().slice(14,14+32);var e=/(\w{8})(\w{4})(\w{4})(\w{4})(\w{12})/;u=u.replace(e,"$1-$2-$3-$4-$5");}return{sFailedLine:f,sSuccessLine:s,sUuid:u};},_parseResponseAsyn:function(r){var c;var d=/<message>(.+?)<\/message>/g;var e=r.match(d);if(e.length===1&&(e[0]==="<message>asyn</message>")){c=true;}return c;},_showErrorLog:function(e,u,c,r,f){var d="/DownloadLogSet(UUID=guid'"+u+"',TYPE='E'"+")/$value";var g=this.getView().getParent().getModel().sServiceUrl+d;var h=this.getText("downloadFailedDatas");if(f===1){b.error(e,{actions:[h,c,b.Action.CLOSE],title:this.getText("Failed"),contentWidth:"30%",contentHeight:"12%",emphasizedAction:h,onClose:function(A){if(A===c){r.navTo("history");}if(A===h){sap.m.URLHelper.redirect(g,false);}}});}else{b.warning(e,{actions:[h,c,b.Action.CLOSE],title:this.getText("partialSuccess"),contentWidth:"30%",contentHeight:"12%",emphasizedAction:h,onClose:function(A){if(A===c){r.navTo("history");}if(A===h){sap.m.URLHelper.redirect(g,false);}}});}},_showAsynInfo:function(i,c,r){b.information(i,{actions:[c,b.Action.CLOSE],contentWidth:"30%",contentHeight:"12%",onClose:function(A){if(A===c){r.navTo("history");}}});},_showSuccessInfo:function(i,c,r){b.success(i,{actions:[c,b.Action.CLOSE],contentWidth:"30%",contentHeight:"12%",onClose:function(A){if(A===c){r.navTo("history");}}});},_showImportResult:function(r,v,R){var f;var c=this._parseResponse(r);if(c.sSuccessLine==="0"&&c.sFailedLine==="0"){this._showError(this.getText("importErrorTemplate"));}else if(c.sSuccessLine==="0"&&(c.sFailedLine==="-1"||c.sFailedLine==="1-")){b.information(this.getText("importNullTemplate"),{actions:[b.Action.OK,b.Action.CLOSE],emphasizedAction:b.Action.OK});}else if(c.sSuccessLine>="0"&&(c.sFailedLine==="-1"||c.sFailedLine==="1-")){b.error(this.getText("uploadMost"),{actions:[b.Action.OK,b.Action.CLOSE],emphasizedAction:b.Action.OK});}else{if(c.sSuccessLine){if(c.sSuccessLine>0&&c.sFailedLine==="0"){this._showSuccessInfo(this.getText("importSuccessText",c.sSuccessLine),v,R);}}else{M.show(this.getText("importSuccessText","0"),{width:"30em"});}if(c.sFailedLine>0&&c.sSuccessLine==="0"){f=1;this._showErrorLog(this.getText("importErrorText"),c.sUuid,v,R,f);}if(c.sFailedLine>0&&c.sSuccessLine>0){f=0;var t=parseInt(c.sSuccessLine,10)+parseInt(c.sFailedLine,10);var d=t.toString();var l=[c.sFailedLine,d];this._showErrorLog(this.getText("importPartialErrorText",l),c.sUuid,v,R,f);}}},_showError:function(e){b.error(e,{actions:[b.Action.OK,b.Action.CLOSE],emphasizedAction:b.Action.OK});}});});
